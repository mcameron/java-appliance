---
  - hosts: all
    sudo: yes
    gather_facts: no
    tasks:
      - name: Update update_cache
        apt: update_cache=yes
      - name: install tomcat
        apt: name="{{ item }}" state=installed
        with_items:
          - tomcat7
          - vim
          - fastjar
      - name: create companyNews directory
        file: path=/var/lib/tomcat7/webapps/companyNews state=directory owner=tomcat7 group=tomcat7 mode=0755
      - name: download file with sha256 check
        get_url: url='https://s3.amazonaws.com/infra-assessment/companyNews.war'  dest=/var/lib/tomcat7/webapps/companyNews/companyNews.war sha256sum=18a59528583270acb56d11f815eb0418d84b62da033c1d308e78d2d4db1bd46e
      - name: update perms of /var/lib/tomcat7/webapps/companyNews
        file: path=/var/lib/tomcat7/webapps/companyNews owner=tomcat7 group=tomcat7
      - name: extract companyNews.war
        command: jar -xvf companyNews.war
        args:
          chdir: /var/lib/tomcat7/webapps/companyNews
          creates: /var/lib/tomcat7/webapps/companyNews/index.jsp
        notify:
          - start tomcat7
      - name: ensure persistence directory structure present
        command: mkdir -p /Users/dcameron/persistence/files
      - name: update perms of dir structure
        command: chown -R tomcat7:tomcat7 /Users
        notify:
          - start tomcat7

    handlers:
      - name: start tomcat7
        service: name=tomcat7 state=restarted
